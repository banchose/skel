FROM debian:trixie

# Defined later in the file
ARG USER_UID=1000
ARG USER_GID=1000
#
# docker build -t py1:latest --build-arg USER_UID="$(id -u)" --build-arg USER_GID="$(id -g)" .

# Example user
# RUN useradd -rm -d /home/ubuntu -s /bin/bash -g root -G sudo -u 1001 ubuntu
# -p "$(openssl passwd -6 YOUR_PASS_HERE)"
#
# OR
#
# SHELL ["/bin/bash", "-o", "pipefail", "-c"]
# RUN echo 'ubuntu:ubuntu' | chpasswd
#
# USER ubuntu
# WORKDIR /home/ubuntu

### ROOT ###

USER root
WORKDIR /root

RUN apt update && apt install -y \
  bash \
  bash-completion  \
  zsh  \
  git \
  curl \
  iproute2 \
  iputils-ping \
  traceroute \
  iperf3 \
  telnet \
  jq \
  net-tools \
  dnsutils \
  sed \
  grep \
  gawk \
  coreutils \
  diffutils \
  lsof \
  vim  \
  zip \
  bzip2 \
  xz-utils \
  inxi \
  gettext \
  manpages \
  man-db \
  fzf \
  unzip \
  p7zip-full \
  ipcalc  \
  tshark \
  strace \
  nmap \
  mtr  \
  wget  \
  tcpdump \
  socat \
  htop  \
  tmux \
  netcat-openbsd \
  tree \
  bat \
  vim  \
  ripgrep \
  btrfs-progs \
  apt-utils \
  fd-find \
  shellcheck \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean

RUN apt update && apt install -y \
 # samurai  \
  libtool \
  ninja-build \
  meson \
  autoconf \
  automake \
  doxygen \
  yasm \
  make \
  cmake \
  gfortran \
  rclone \
  gcc \
  g++ \
  gdb \
  pigz \
  nasm \
  luajit \
  lua5.1-doc \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean

RUN curl -v -L -o /usr/bin/kubectl "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" && chmod +x /usr/bin/kubectl

RUN curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && \
unzip awscliv2.zip && \
./aws/install

RUN curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb" && \
dpkg -i session-manager-plugin.deb


RUN ARCH=amd64 && \
    PLATFORM=$(uname -s)_$ARCH && \
    curl -sLO "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz" && \
    curl -sL "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_checksums.txt" | grep $PLATFORM | sha256sum --check && \
    tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp && \
    rm eksctl_$PLATFORM.tar.gz && \
    install -m 0755 /tmp/eksctl /usr/local/bin && \
    rm /tmp/eksctl

# As root
RUN apt update && apt install -y \
  python3.13-venv \
  pip \
  faker \
  python3-pynvim \
  ipython3 \
  python3-ipython \
  ptpython \
  pylint \
  python3-networkx \
  python3-httpx \
  python3-requests \
  python3-boto3 \
  python3-arrow  \
  python3-cryptography \
  python3-loguru \
  python3-icecream \
  python3-scipy \
  python3-simpy \
  python3-numpy \
  python3-purl \
  python3-certifi \
  python3-pydantic \
  python3-twisted \
  twisted-doc \
  python3-jinja2 \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean 


RUN apt update && apt install -y \
  units \
  pandoc \
  pwgen \
  aria2 \
  s3cmd \
  texlive \
  texinfo \
  hping3 \
  ngrep \
  asciinema \
  # exa \
  duf \
  # tldr \
  dsniff \
  qalc \
  bc \
  iftop \
  silversearcher-ag \
  openvpn \
  gperf  \
  dc \
  ranger \
  pv \
  nano \
  httpie \
  black \
  sqlite3 \
  pgcli \
  btop \
  iftop \
  emacs-nox \
  units \
  w3m \
  libpcsclite-dev \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean


RUN apt update && apt install -y \
    build-essential cmake autoconf automake libtool pkg-config \
    zlib1g-dev libbz2-dev liblzma-dev libzstd-dev \
    libssl-dev libgcrypt20-dev \
    libxml2-dev libexpat1-dev \
    libfuse-dev libpcsclite-dev \
    libcurl4-openssl-dev \
    libsqlite3-dev \
    libncurses-dev \
    libopenblas-dev \
    liblua5.1-0-dev \
    libpcsclite-dev \
    libopenblas-dev \
    libfuse-dev \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean



####### Install a newer pipx supporting multiple arguments
RUN python3 -m pip install --break-system-packages pipx

# Install golang - go
RUN wget https://go.dev/dl/go1.25.5.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.25.5.linux-amd64.tar.gz && \
    rm go1.25.5.linux-amd64.tar.gz
ENV PATH=$PATH:/usr/local/go/bin:/home/loon/go/bin



RUN groupadd -g ${USER_UID} loon && \
  useradd -m -u ${USER_UID} -g ${USER_GID} -s /bin/bash loon

##################### CHANGE USER ###################################
USER loon:loon
ENV PATH="/home/loon/.local/bin:/home/loon/go/bin:/home/loon/.cargo/bin:/usr/local/go/bin:/usr/local/bin:/usr/bin:/bin"

RUN mkdir -p /home/loon/gitdir /home/loon/work /home/loon/.bashrc_zen.d

WORKDIR /home/loon

RUN pipx install \
pycowsay \
flake8 \
pylint \
black \
ruff \
pgcli \
cfn-lint \
csvkit \
s3cmd \
ptpython \
posting \
isort \
icecream \
markitdown \
scrapy \
--pip-args="--upgrade" \
--include-deps

# llm
RUN pipx install llm \
--pip-args="--upgrade" \
--include-deps

RUN llm install \
llm-anthropic \
llm-tools-exa \
llm-openrouter \
llm-gemini \
llm-bedrock  \
llm-bedrock-anthropic  \
# llm-bedrock-meta  \
# llm-ollama \
llm-tools-quickjs \
llm-tools-sqlite \
llm-tools-rag \
# llm-fragments-pdf \
llm-fragments-site-text \
llm-templates-github \
llm-fragments-github \
llm-tools-simpleeval \
llm-cmd-comp \
llm-cmd \
llm-python \
llm-jq \
llm-templates-fabric

RUN llm models default anthropic/claude-sonnet-4-5

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

# Install golang - go
# RUN wget https://go.dev/dl/go1.25.5.linux-amd64.tar.gz && \
#     rm -rf /home/loon/go && \
#     tar -C /home/loon -xzf go1.25.5.linux-amd64.tar.gz && \
#     rm go1.25.5.linux-amd64.tar.gz
# 
# ENV PATH=$PATH:/usr/local/go/bin
# 
# RUN curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz && \
#     tar -C /home/loon/.local --strip-components=1 -xzf nvim-linux-x86_64.tar.gz && \
#     rm nvim-linux-x86_64.tar.gz
# 
# 
# RUN mkdir -p /home/loon/.config/nvim
# RUN git clone https://github.com/LazyVim/starter ~/.config/nvim
# # First sync LazyVim and install plugins
# # RUN nvim --headless "+Lazy! sync" +qa 2>&1 || true
# # Then update tree-sitter parsers (plugins are now installed)
# RUN nvim --headless \
#   "+Lazy! sync" \
#   "+sleep 2" \
#   "+TSUpdate" \
#   +qa

RUN go install github.com/akavel/up@latest
RUN go install github.com/charmbracelet/glow/v2@latest
RUN pipx install visidata 'litellm[proxy]' --include-deps
RUN pipx install pudb
RUN pipx install bpython --include-deps

COPY --chown=loon:loon bash_profile /home/loon/.bash_profile
COPY --chown=loon:loon bashrc /home/loon/.bashrc
COPY --chown=loon:loon inputrc /home/loon/.inputrc
COPY --chown=loon:loon tmux.conf /home/loon/.tmux.conf
COPY --chown=loon:loon gitconfig /home/loon/.gitconfig
COPY --chown=loon:loon awsconfig /home/loon/.aws/config

WORKDIR /home/loon/gitdir
RUN ls -ld /home/loon /home/loon/gitdir && id

RUN git clone --depth=1 https://github.com/banchose/skel
# RUN git clone --depth=1 https://github.com/neovim/neovim
RUN git clone --depth=1 https://github.com/lazyvim/starter
RUN git clone --depth=1 https://github.com/gto76/python-cheatsheet
RUN git clone --depth=1 https://github.com/donnemartin/interactive-coding-challenges
RUN git clone --depth=1 https://github.com/realpython/python-guide
RUN git clone --depth=1 https://github.com/yidao620c/python3-cookbook
RUN git clone --depth=1 https://github.com/TheAlgorithms/Python
RUN git clone --depth=1 https://github.com/simonw/llm

# RUN mkdir -p /home/loon/.bashrc_zen.d && \
# chown -R loon:loon /home/loon/.bashrc_zen.d

RUN mkdir -p /home/loon/.bashrc_zen.d

COPY --chown=loon:loon dummy_xxx_.sh /home/loon/.bashrc_zen.d
RUN ln -s /home/loon/gitdir/skel/bash/bashrc_zen.d/aws.sh /home/loon/.bashrc_zen.d
RUN ln -s /home/loon/gitdir/skel/bash/bashrc_zen.d/nvim_chooser.sh /home/loon/.bashrc_zen.d
RUN ln -s /home/loon/gitdir/skel/bash/bashrc_zen.d/nvim.sh /home/loon/.bashrc_zen.d
RUN ln -s /home/loon/gitdir/skel/bash/bashrc_zen.d/kubernetes.sh /home/loon/.bashrc_zen.d
RUN ln -s /home/loon/gitdir/skel/bash/bashrc_zen.d/docker.sh /home/loon/.bashrc_zen.d
RUN ln -s /home/loon/gitdir/skel/bash/bashrc_zen.d/llm-cli.sh /home/loon/.bashrc_zen.d
RUN ln -s /home/loon/gitdir/skel/bash/bashrc_zen.d/tmux.sh /home/loon/.bashrc_zen.d

WORKDIR /home/loon/work

## Additional user installs
#
# RUN pipx install aider-install && pipx inject aider-install boto3 && aider-install
# RUN pipx install rich-cli --include-deps

COPY --chown=loon:loon README-py1.md /home/loon/work
COPY --chown=loon:loon aws /home/loon/work/aws
COPY --chown=loon:loon scripts/testme.sh /home/loon/work/scripts/testme.sh
RUN chmod 755 /home/loon/work/scripts/testme.sh
COPY --chown=loon:loon Dockerfile /home/loon/work/Docker/Dockerfile
COPY --chown=loon:loon scripts /home/loon/work/scripts
RUN chmod 755 /home/loon/work/scripts/init-lazy.sh

# RUN pipx install --include-deps aider-chat && \
# pipx inject aider-chat boto3

# RUN curl -fsSL https://claude.ai/install.sh | bash

COPY --chown=loon:loon settings.json /home/loon/.claude/settings.json
COPY --chown=loon:loon anthropic_keys.sh /home/loon/.claude/anthropic_keys.sh
RUN chmod 755 /home/loon/.claude/anthropic_keys.sh
RUN ls -la /home/loon/.claude/anthropic_keys.sh
RUN cat /home/loon/.claude/anthropic_keys.sh

USER root
RUN apt update
USER loon

SHELL ["/bin/bash", "-o", "pipefail", "-c"]
ENV BASH_ENV /home/loon/.bash_env
RUN touch "${BASH_ENV}"
RUN echo '. "${BASH_ENV}"' >> ~/.bashrc

# Download and install nvm
RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | PROFILE="${BASH_ENV}" bash
RUN echo node > .nvmrc
RUN nvm install

RUN curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz && \
    tar -C /home/loon/.local --strip-components=1 -xzf nvim-linux-x86_64.tar.gz && \
    rm nvim-linux-x86_64.tar.gz

RUN mkdir -p /home/loon/.config/nvim
RUN git clone https://github.com/LazyVim/starter ~/.config/nvim
# First sync LazyVim and install plugins
# RUN nvim --headless "+Lazy! sync" +qa 2>&1 || true
# Then update tree-sitter parsers (plugins are now installed)
# RUN nvim --headless \
#   "+Lazy! sync" \
#   "+sleep 2" \
#   "+TSInstall all" \
#   +qa
# 

RUN wget https://luarocks.org/releases/luarocks-3.12.2.tar.gz \
  tar zxpf luarocks-3.12.2.tar.gz \
  cd luarocks-3.12.2 \
  ./configure && make && sudo make install
  sudo luarocks install luasocket \
  lua

# Ensure Node.js is available first
RUN bash -c "source ${BASH_ENV} && nvim --headless '+Lazy! sync' +qa"

# Install all parsers with sufficient time
RUN bash -c "source ${BASH_ENV} && nvim --headless '+TSInstall all' +qa" || true

# Wait and verify
RUN sleep 5

# Check what was actually installed
RUN bash -c "source ${BASH_ENV} && nvim --headless '+TSInstallInfo' '+sleep 3' +qa" || true
# After installing LazyVim
RUN bash -c "source ${BASH_ENV} && nvim --headless '+Lazy! build blink.cmp' +qa" || true

# Create gitdir with proper ownership BEFORE switching users
# ENTRYPOINT ["/bin/sleep"]
# CMD ["100000"]
ENTRYPOINT ["/bin/bash"]
CMD ["-l"]
# CMD ["-v"]
